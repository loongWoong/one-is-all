<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
    <title>Markdownç¼–è¾‘å™¨ - ä»¿Typora</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            display: flex;
            height: 100vh;
            background-color: #f8f9fa;
            color: #333;
            font-size: 16px;
            line-height: 1.6;
        }

        /* å·¥å…·æ æ ·å¼ */
        .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 100;
        }

        .toolbar button {
            background: none;
            border: none;
            font-size: 14px;
            padding: 5px 10px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .toolbar button:hover {
            background-color: #e9ecef;
        }

        /* ç¼–è¾‘å™¨ä¸»å®¹å™¨ */
        .editor-container {
            display: flex;
            flex: 1;
            margin-top: 50px;
            height: calc(100vh - 50px);
        }

        /* ç¼–è¾‘åŒºåŸŸ */
        .editor {
            flex: 1;
            padding: 20px;
            outline: none;
            background-color: white;
            border: none;
            resize: none;
            font-size: 16px;
            line-height: 1.6;
            border-right: 1px solid #e9ecef;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            tab-size: 4;
            -moz-tab-size: 4;
        }

        /* é¢„è§ˆåŒºåŸŸ */
        .preview {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }

        /* å…¨å±æ¨¡å¼ */
        .fullscreen .toolbar {
            display: none;
        }

        .fullscreen .editor-container {
            margin-top: 0;
            height: 100vh;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 6px 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        /* åˆ†å‰²çº¿ */
        .divider {
            width: 1px;
            background-color: #e9ecef;
            margin: 0 10px;
            height: 24px;
        }

        /* ä¸‹æ‹‰èœå• */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 1;
            border-radius: 4px;
            top: 30px;
        }

        .dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .dropdown-content a:hover {
            background-color: #f8f9fa;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        /* Markdown æ ·å¼ */
        .preview h1, .preview h2, .preview h3, .preview h4, .preview h5, .preview h6 {
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
            line-height: 1.25;
        }

        .preview h1 {
            font-size: 2em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .preview h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
        }

        .preview h3 {
            font-size: 1.25em;
        }

        .preview h4 {
            font-size: 1em;
        }

        .preview h5 {
            font-size: 0.875em;
        }

        .preview h6 {
            font-size: 0.85em;
            color: #6a737d;
        }

        .preview p {
            margin-top: 0;
            margin-bottom: 16px;
        }

        .preview a {
            color: #0366d6;
            text-decoration: none;
        }

        .preview a:hover {
            text-decoration: underline;
        }

        .preview pre {
            padding: 16px;
            overflow: auto;
            font-size: 85%;
            line-height: 1.45;
            background-color: #f6f8fa;
            border-radius: 6px;
            white-space: pre;
            tab-size: 4;
            -moz-tab-size: 4;
        }

        .preview code {
            padding: 0.2em 0.4em;
            margin: 0;
            font-size: 85%;
            background-color: rgba(27,31,35,0.05);
            border-radius: 6px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, Courier, monospace;
            white-space: pre-wrap;
        }

        .preview pre code {
            padding: 0;
            margin: 0;
            font-size: 100%;
            background-color: transparent;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, Courier, monospace;
            white-space: pre;
            tab-size: 4;
            -moz-tab-size: 4;
        }

        .preview pre code.language-javascript,
        .preview pre code.language-js {
            color: #333;
        }

        .preview pre code.language-html {
            color: #e44d26;
        }

        .preview pre code.language-css {
            color: #264de4;
        }

        .preview pre code.language-python {
            color: #3572A5;
        }

        /* Highlight.js æ ·å¼ */
        .preview pre code.hljs {
            display: block;
            overflow-x: auto;
            padding: 0.5em;
            background: #f6f8fa;
        }

        .preview pre code.hljs .hljs-keyword,
        .preview pre code.hljs .hljs-selector-tag,
        .preview pre code.hljs .hljs-subst {
            color: #333;
            font-weight: bold;
        }

        .preview pre code.hljs .hljs-number,
        .preview pre code.hljs .hljs-literal,
        .preview pre code.hljs .hljs-variable,
        .preview pre code.hljs .hljs-template-variable,
        .preview pre code.hljs .hljs-tag .hljs-attr {
            color: #008080;
        }

        .preview pre code.hljs .hljs-string,
        .preview pre code.hljs .hljs-doctag {
            color: #d14;
        }

        .preview pre code.hljs .hljs-title,
        .preview pre code.hljs .hljs-section,
        .preview pre code.hljs .hljs-selector-id {
            color: #900;
            font-weight: bold;
        }

        .preview pre code.hljs .hljs-subst {
            font-weight: normal;
        }

        .preview pre code.hljs .hljs-type,
        .preview pre code.hljs .hljs-class .hljs-title {
            color: #458;
            font-weight: bold;
        }

        .preview pre code.hljs .hljs-tag,
        .preview pre code.hljs .hljs-name,
        .preview pre code.hljs .hljs-attribute {
            color: #000080;
            font-weight: normal;
        }

        .preview pre code.hljs .hljs-regexp,
        .preview pre code.hljs .hljs-link {
            color: #009926;
        }

        .preview pre code.hljs .hljs-symbol,
        .preview pre code.hljs .hljs-bullet {
            color: #990073;
        }

        .preview pre code.hljs .hljs-built_in,
        .preview pre code.hljs .hljs-builtin-name {
            color: #0086b3;
        }

        .preview pre code.hljs .hljs-meta {
            color: #999;
            font-weight: bold;
        }

        .preview pre code.hljs .hljs-deletion {
            background: #fdd;
        }

        .preview pre code.hljs .hljs-addition {
            background: #dfd;
        }

        .preview pre code.hljs .hljs-emphasis {
            font-style: italic;
        }

        .preview pre code.hljs .hljs-strong {
            font-weight: bold;
        }

        .preview blockquote {
            padding: 0 1em;
            color: #6a737d;
            border-left: 0.25em solid #dfe2e5;
            margin: 0 0 16px;
        }

        .preview ul, .preview ol {
            padding-left: 2em;
            margin-bottom: 16px;
        }

        .preview li {
            margin-bottom: 4px;
        }

        .preview table {
            display: block;
            width: 100%;
            overflow: auto;
            border-collapse: collapse;
            margin-bottom: 16px;
            border-spacing: 0;
            border-collapse: collapse;
        }

        .preview table th, .preview table td {
            padding: 6px 13px;
            border: 1px solid #dfe2e5;
        }

        .preview table tr:nth-child(2n) {
            background-color: #f6f8fa;
        }

        /* wolaiç‰¹è‰²åŠŸèƒ½æ ·å¼ */
        .todo-list {
            list-style: none;
            padding-left: 0;
        }

        .todo-list-item {
            list-style: none;
            margin-bottom: 5px;
        }

        .todo-list-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }

        .todo-list-item.checked {
            text-decoration: line-through;
            color: #6c757d;
        }

        .callout {
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 6px;
            background-color: #f0f4f8;
            border-left: 4px solid #4285f4;
        }

        .callout.info {
            background-color: #e8f0fe;
            border-left-color: #4285f4;
        }

        .callout.warning {
            background-color: #fef7e0;
            border-left-color: #f9ab00;
        }

        .callout.error {
            background-color: #fce8e6;
            border-left-color: #ea4335;
        }

        .highlight {
            background-color: #ffeb3b;
            padding: 0 2px;
            border-radius: 3px;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 25px;
            background-color: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 10px;
            font-size: 12px;
            color: #6c757d;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .editor-container {
                flex-direction: column;
            }
            
            .editor, .preview {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
        }

        /* æ–‡ä»¶æ“ä½œä¸‹æ‹‰èœå• */
        .file-dropdown {
            position: relative;
            display: inline-block;
        }

        .file-dropdown-btn {
            background: none;
            border: none;
            font-size: 14px;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
        }

        .file-dropdown-btn:hover {
            background-color: #e9ecef;
        }

        .file-dropdown-content {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            z-index: 1;
            border-radius: 4px;
            top: 30px;
            left: 0;
        }

        .file-dropdown-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        .file-dropdown-content a:hover {
            background-color: #f8f9fa;
        }

        .file-dropdown:hover .file-dropdown-content {
            display: block;
        }

        /* wolaiåŠŸèƒ½æŒ‰é’® */
        .wolai-btn {
            background: none;
            border: none;
            font-size: 14px;
            padding: 5px 10px;
            margin-right: 10px;
            cursor: pointer;
            border-radius: 4px;
            color: #6c757d;
        }

        .wolai-btn:hover {
            background-color: #e9ecef;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .search-container {
            position: relative;
            margin-left: 10px;
        }

        .search-input {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* ç›®å½•å¯¼èˆª */
        .toc {
            position: fixed;
            right: 20px;
            top: 70px;
            width: 200px;
            max-height: calc(100vh - 120px);
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            overflow-y: auto;
            z-index: 99;
            display: none;
        }

        .toc.show {
            display: block;
        }

        .toc h3 {
            margin-top: 0;
            font-size: 14px;
            color: #6c757d;
        }

        .toc ul {
            padding-left: 15px;
        }

        .toc a {
            text-decoration: none;
            color: #333;
            font-size: 13px;
            display: block;
            padding: 3px 0;
        }

        .toc a:hover {
            color: #007bff;
        }

        /* åŒå‡»æ»šåŠ¨åŒæ­¥æ ·å¼ */
        .preview .sync-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            transition: background-color 0.5s;
        }
        .sidebar {
            width: 240px;
            background: white;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .sidebar-title {
            font-size: 14px;
            color: #6c757d;
        }
        .sidebar-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .sidebar-btn:hover {
            background-color: #f8f9fa;
        }
        .file-list {
            flex: 1;
            overflow-y: auto;
        }
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid #f1f3f5;
            cursor: pointer;
        }
        .file-item:hover {
            background-color: #f8f9fa;
        }
        .file-name {
            font-size: 14px;
            color: #333;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .file-meta {
            font-size: 12px;
            color: #6c757d;
        }
        .file-actions {
            display: flex;
            gap: 6px;
        }
        .file-action {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 12px;
        }
        .file-action:hover {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- å·¥å…·æ  -->
    <div class="toolbar">
        <div class="file-dropdown">
            <button class="file-dropdown-btn">æ–‡ä»¶</button>
            <div class="file-dropdown-content">
                <a href="#" id="newFile">æ–°å»º</a>
                <a href="#" id="openFile">æ‰“å¼€</a>
                <a href="#" id="saveFile">ä¿å­˜</a>
                <a href="#" id="downloadMd">ä¸‹è½½ Markdown</a>
                <a href="#" id="downloadHtml">ä¸‹è½½ HTML</a>
            </div>
        </div>
        <div class="divider"></div>
        <button id="boldBtn" title="ç²—ä½“ (Ctrl+B)">B</button>
        <button id="italicBtn" title="æ–œä½“ (Ctrl+I)">I</button>
        <button id="headingBtn" title="æ ‡é¢˜ (Ctrl+H)">H</button>
        <div class="divider"></div>
        <button id="linkBtn" title="é“¾æ¥ (Ctrl+K)">ğŸ”—</button>
        <button id="imageBtn" title="å›¾ç‰‡ (Ctrl+Shift+I)">ğŸ–¼ï¸</button>
        <div class="divider"></div>
        <button id="ulBtn" title="æ— åºåˆ—è¡¨ (Ctrl+U)">â€¢</button>
        <button id="olBtn" title="æœ‰åºåˆ—è¡¨ (Ctrl+Shift+O)">1.</button>
        <button id="todoListBtn" title="å¾…åŠåˆ—è¡¨ (Ctrl+Shift+T)">â˜‘</button>
        <button id="quoteBtn" title="å¼•ç”¨ (Ctrl+Q)">Â»</button>
        <div class="divider"></div>
        <button id="codeBtn" title="ä»£ç å— (Ctrl+Shift+C)">âŒ¨</button>
        <button id="hrBtn" title="åˆ†å‰²çº¿ (Ctrl+Shift+H)">â€”</button>
        <div class="divider"></div>
        <button id="highlightBtn" title="é«˜äº® (Ctrl+Shift+H)">â˜…</button>
        <button id="calloutInfoBtn" title="ä¿¡æ¯å—">â„¹</button>
        <button id="calloutWarningBtn" title="è­¦å‘Šå—">âš </button>
        <button id="calloutErrorBtn" title="é”™è¯¯å—">â—</button>
        <div class="divider"></div>
        <button id="previewToggle" title="åˆ‡æ¢é¢„è§ˆ (Ctrl+P)">ğŸ‘ï¸</button>
        <button id="fullscreenBtn" title="å…¨å± (F11)">â›¶</button>
        <button id="tocToggle" title="ç›®å½• (Ctrl+J)">â‰¡</button>
        <div class="search-container">
            <input type="text" class="search-input" id="searchInput" placeholder="æœç´¢..." title="æœç´¢ (Ctrl+F)">
        </div>
    </div>

    <!-- ç›®å½•å¯¼èˆª -->
    <div class="toc" id="toc">
        <h3>ç›®å½•</h3>
        <ul id="tocList"></ul>
    </div>

    <!-- ç¼–è¾‘å™¨ä¸»å®¹å™¨ -->
    <div class="editor-container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-title">æ–‡ä»¶</span>
                <button class="sidebar-btn" id="newSidebarFile">æ–°å»º</button>
            </div>
            <div class="file-list" id="fileList"></div>
        </div>
        <textarea id="editor" class="editor" placeholder="å¼€å§‹ç¼–å†™ Markdown..."># æ¬¢è¿ä½¿ç”¨ Markdown ç¼–è¾‘å™¨

è¿™æ˜¯ä¸€ä¸ªä»¿ Typora é£æ ¼çš„åœ¨çº¿ Markdown ç¼–è¾‘å™¨ï¼Œæ”¯æŒå®æ—¶é¢„è§ˆã€‚

## åŠŸèƒ½ç‰¹æ€§

- å®æ—¶é¢„è§ˆ
- å¿«æ·æŒ‰é’®æ“ä½œ
- å…¨å±æ¨¡å¼
- æ–‡ä»¶ä¿å­˜ä¸å¯¼å‡º
- å¿«æ·é”®æ”¯æŒ
- wolai ç‰¹è‰²åŠŸèƒ½

## wolai ç‰¹è‰²åŠŸèƒ½æ¼”ç¤º

### å¾…åŠäº‹é¡¹åˆ—è¡¨

[ ] å®Œæˆé¡¹ç›®è®¡åˆ’
[x] è®¾è®¡UIç•Œé¢
[ ] å®ç°æ ¸å¿ƒåŠŸèƒ½
[x] æµ‹è¯•å…¼å®¹æ€§

### æ–‡æœ¬é«˜äº®æ•ˆæœ

è¿™æ˜¯ ==é‡è¦ä¿¡æ¯==ï¼Œéœ€è¦ç‰¹åˆ«å…³æ³¨ã€‚

### ä¿¡æ¯å—

!!!info
è¿™æ˜¯ä¸€ä¸ªä¿¡æ¯æç¤ºå—ï¼Œç”¨äºæä¾›é¢å¤–ä¿¡æ¯ã€‚
!!!

!!!warning
è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šæç¤ºå—ï¼Œç”¨äºæé†’æ³¨æ„äº‹é¡¹ã€‚
!!!

!!!error
è¿™æ˜¯ä¸€ä¸ªé”™è¯¯æç¤ºå—ï¼Œç”¨äºæŒ‡å‡ºé”™è¯¯æˆ–é—®é¢˜ã€‚
!!!

### ä»£ç å—é«˜äº®ç¤ºä¾‹

```
// JavaScript ç¤ºä¾‹ä»£ç 
function helloWorld() {
  console.log("Hello, World!");
  return true;
}

const obj = {
  name: "ç¤ºä¾‹",
  value: 42
};
```

```
# Python ç¤ºä¾‹ä»£ç 
def hello_world():
    print("Hello, World!")
    return True

class Example:
    def __init__(self, name, value):
        self.name = name
        self.value = value
```

```
<!-- HTML ç¤ºä¾‹ä»£ç  -->
<!DOCTYPE html>
<html>
<head>
  <title>ç¤ºä¾‹é¡µé¢</title>
</head>
<body>
  <h1>æ¬¢è¿</h1>
  <p>è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹æ®µè½ã€‚</p>
</body>
</html>
```

```
/* CSS ç¤ºä¾‹ä»£ç  */
body {
  font-family: Arial, sans-serif;
  background-color: #f0f0f0;
}

.header {
  color: #333;
  font-size: 24px;
  margin-bottom: 10px;
}
```

## å¿«æ·é”®è¯´æ˜

| å¿«æ·é”® | åŠŸèƒ½ |
|--------|------|
| Ctrl+N | æ–°å»ºæ–‡ä»¶ |
| Ctrl+O | æ‰“å¼€æ–‡ä»¶ |
| Ctrl+S | ä¿å­˜æ–‡ä»¶ |
| Ctrl+Z | æ’¤é”€ |
| Ctrl+Y | é‡åš |
| Ctrl+B | ç²—ä½“ |
| Ctrl+I | æ–œä½“ |
| Ctrl+H | æ ‡é¢˜ |
| Ctrl+K | æ’å…¥é“¾æ¥ |
| Ctrl+Shift+I | æ’å…¥å›¾ç‰‡ |
| Ctrl+U | æ— åºåˆ—è¡¨ |
| Ctrl+Shift+O | æœ‰åºåˆ—è¡¨ |
| Ctrl+Shift+T | å¾…åŠåˆ—è¡¨ |
| Ctrl+Q | å¼•ç”¨ |
| Ctrl+Shift+C | ä»£ç å— |
| Ctrl+Shift+H | åˆ†å‰²çº¿/é«˜äº® |
| Ctrl+P | åˆ‡æ¢é¢„è§ˆ |
| Ctrl+J | æ˜¾ç¤º/éšè—ç›®å½• |
| Ctrl+F | æœç´¢ |
| F11 | å…¨å± |

äº«å—ä½ çš„å†™ä½œä¹‹æ—…ï¼</textarea>
        <div id="preview" class="preview"></div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <span id="wordCount">å­—æ•°: 0</span>
        <span style="margin-left: 10px;" id="charCount">å­—ç¬¦: 0</span>
        <span style="margin-left: 10px;" id="lineCount">è¡Œæ•°: 1</span>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥å…ƒç´  -->
    <input type="file" id="fileInput" accept=".md,.markdown" style="display: none;">

    <script>
        // å‘½ä»¤å†å²è®°å½•ç³»ç»Ÿ
        const history = {
            states: [''],
            currentIndex: 0,
            maxLength: 50, // æœ€å¤§å†å²è®°å½•æ•°
            
            // ä¿å­˜å½“å‰çŠ¶æ€
            saveState: function(content) {
                // å¦‚æœå½“å‰ç´¢å¼•ä¸åœ¨å†å²è®°å½•æœ«å°¾ï¼Œåˆ é™¤ä¹‹åçš„æ‰€æœ‰è®°å½•
                if (this.currentIndex < this.states.length - 1) {
                    this.states = this.states.slice(0, this.currentIndex + 1);
                }
                
                // æ·»åŠ æ–°çŠ¶æ€
                this.states.push(content);
                this.currentIndex++;
                
                // é™åˆ¶å†å²è®°å½•é•¿åº¦
                if (this.states.length > this.maxLength) {
                    this.states.shift();
                    this.currentIndex--;
                }
            },
            
            // æ’¤é”€
            undo: function() {
                if (this.canUndo()) {
                    this.currentIndex--;
                    return this.states[this.currentIndex];
                }
                return null;
            },
            
            // é‡åš
            redo: function() {
                if (this.canRedo()) {
                    this.currentIndex++;
                    return this.states[this.currentIndex];
                }
                return null;
            },
            
            // æ˜¯å¦å¯ä»¥æ’¤é”€
            canUndo: function() {
                return this.currentIndex > 0;
            },
            
            // æ˜¯å¦å¯ä»¥é‡åš
            canRedo: function() {
                return this.currentIndex < this.states.length - 1;
            }
        };

        // è·å–DOMå…ƒç´ 
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const wordCount = document.getElementById('wordCount');
        const charCount = document.getElementById('charCount');
        const lineCount = document.getElementById('lineCount');
        const fileInput = document.getElementById('fileInput');
        const toc = document.getElementById('toc');
        const tocList = document.getElementById('tocList');
        const searchInput = document.getElementById('searchInput');
        const fileListEl = document.getElementById('fileList');
        const newSidebarFileBtn = document.getElementById('newSidebarFile');
        let currentFileId = null;

        // åˆå§‹åŒ–å†å²è®°å½•
        history.saveState(editor.value);

        // Markdownè§£æå‡½æ•°
        function parseMarkdown(text) {
            const escapeHtml = (str) => str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (match, lang, code) => {
                const normalizedCode = code.replace(/\t/g, '    ');
                if (lang) {
                    return `<pre><code class="language-${lang}">${escapeHtml(normalizedCode)}</code></pre>`;
                } else {
                    return `<pre><code>${escapeHtml(normalizedCode)}</code></pre>`;
                }
            });
            
            text = text.replace(/```([\s\S]*?)```/g, (match, p1) => {
                const normalizedCode = p1.replace(/\t/g, '    ');
                return `<pre><code>${escapeHtml(normalizedCode)}</code></pre>`;
            });
            
            // è½¬æ¢è¡Œå†…ä»£ç 
            text = text.replace(/`(.*?)`/g, (m, c) => `<code>${escapeHtml(c)}</code>`);
            
            // è½¬æ¢å›¾ç‰‡
            text = text.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width: 100%;">');
            
            // è½¬æ¢é“¾æ¥
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            
            // è½¬æ¢æ ‡é¢˜å¹¶æ·»åŠ é”šç‚¹
            text = text.replace(/^###### (.*$)/gim, '<h6 id="heading-$1"><a href="#heading-$1">#</a> $1</h6>');
            text = text.replace(/^##### (.*$)/gim, '<h5 id="heading-$1"><a href="#heading-$1">#</a> $1</h5>');
            text = text.replace(/^#### (.*$)/gim, '<h4 id="heading-$1"><a href="#heading-$1">#</a> $1</h4>');
            text = text.replace(/^### (.*$)/gim, '<h3 id="heading-$1"><a href="#heading-$1">#</a> $1</h3>');
            text = text.replace(/^## (.*$)/gim, '<h2 id="heading-$1"><a href="#heading-$1">#</a> $1</h2>');
            text = text.replace(/^# (.*$)/gim, '<h1 id="heading-$1"><a href="#heading-$1">#</a> $1</h1>');
            
            // è½¬æ¢ç²—ä½“
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/__(.*?)__/g, '<strong>$1</strong>');
            
            // è½¬æ¢æ–œä½“
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            
            // è½¬æ¢å¼•ç”¨
            text = text.replace(/^> (.*$)/gim, '<blockquote>$1</blockquote>');
            
            // è½¬æ¢å¾…åŠåˆ—è¡¨
            text = text.replace(/^\[ \] (.*$)/gim, '<li class="todo-list-item"><input type="checkbox"> $1</li>');
            text = text.replace(/^\[x\] (.*$)/gim, '<li class="todo-list-item checked"><input type="checkbox" checked> $1</li>');
            text = text.replace(/(<li class="todo-list-item.*<\/li>)/gs, '<ul class="todo-list">$1</ul>');
            
            // è½¬æ¢æ— åºåˆ—è¡¨
            text = text.replace(/^\- (.*$)/gim, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
            
            // è½¬æ¢æœ‰åºåˆ—è¡¨
            text = text.replace(/^\d+\. (.*$)/gim, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>)/gs, '<ol>$1</ol>');
            
            // è½¬æ¢åˆ†å‰²çº¿
            text = text.replace(/^\-\-\-$/gim, '<hr>');
            
            // è½¬æ¢é«˜äº®æ–‡æœ¬
            text = text.replace(/==(.*?)==/g, '<span class="highlight">$1</span>');
            
            // è½¬æ¢ä¿¡æ¯å—
            text = text.replace(/^!!!info\n([\s\S]*?)!!!$/gm, '<div class="callout info">$1</div>');
            text = text.replace(/^!!!warning\n([\s\S]*?)!!!$/gm, '<div class="callout warning">$1</div>');
            text = text.replace(/^!!!error\n([\s\S]*?)!!!$/gm, '<div class="callout error">$1</div>');
            
            {
                const lines = text.split('\n');
                let inPre = false;
                text = lines.map(line => {
                    if (!line) return '';
                    if (line.includes('<pre')) { inPre = true; return line; }
                    if (line.includes('</pre>')) { inPre = false; return line; }
                    if (inPre) return line;
                    if (/^</.test(line)) return line;
                    return `<p>${line}</p>`;
                }).join('\n');
            }
            
            // å¤„ç†æ¢è¡Œï¼Œä½†ä¿ç•™ä»£ç å—å†…çš„æ¢è¡Œ
            const codeBlockRegex = /(<pre><code.*?>)([\s\S]*?)(<\/code><\/pre>)/g;
            const codeBlocks = [];
            
            // æå–ä»£ç å—
            text = text.replace(codeBlockRegex, (match, openTag, content, closeTag) => {
                const index = codeBlocks.length;
                // ä¿ç•™ä»£ç å—ä¸­çš„æ¢è¡Œç¬¦
                const preservedContent = content.replace(/\n/g, '__NEWLINE__');
                codeBlocks.push(preservedContent);
                return `${openTag}CODE_BLOCK_${index}${closeTag}`;
            });
            
            // å¤„ç†éä»£ç å—åŒºåŸŸçš„æ¢è¡Œ
            text = text.replace(/\n/g, '<br>');
            
            // æ¢å¤ä»£ç å—å†…å®¹ï¼Œä¿æŒåŸå§‹æ ¼å¼
            text = text.replace(/CODE_BLOCK_(\d+)/g, (match, index) => {
                // æ¢å¤ä»£ç å—ä¸­çš„æ¢è¡Œç¬¦
                return codeBlocks[index].replace(/__NEWLINE__/g, '\n');
            });
            
            return text;
        }

        // ç”Ÿæˆç›®å½•
        function generateTOC() {
            const headings = [];
            const lines = editor.value.split('\n');
            
            lines.forEach(line => {
                const headingMatch = line.match(/^(#{1,6})\s+(.*)$/);
                if (headingMatch) {
                    const level = headingMatch[1].length;
                    const text = headingMatch[2];
                    const id = 'heading-' + text.replace(/\s+/g, '-');
                    headings.push({ level, text, id });
                }
            });
            
            // æ¸…ç©ºç°æœ‰ç›®å½•
            tocList.innerHTML = '';
            
            // ç”Ÿæˆç›®å½•é¡¹
            headings.forEach(heading => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = '#' + heading.id;
                a.textContent = heading.text;
                a.style.paddingLeft = (heading.level - 1) * 10 + 'px';
                li.appendChild(a);
                tocList.appendChild(li);
            });
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            preview.innerHTML = parseMarkdown(editor.value);
            
            // åº”ç”¨ä»£ç é«˜äº®
            setTimeout(() => {
                preview.querySelectorAll('pre code').forEach((block) => {
                    // ç¡®ä¿ä»£ç å—å†…å®¹æ­£ç¡®æ˜¾ç¤ºåå†è¿›è¡Œé«˜äº®
                    hljs.highlightElement(block);
                    // å¼ºåˆ¶é‡æ–°è®¡ç®—æ ·å¼ä»¥ç¡®ä¿é«˜äº®æ­£ç¡®æ˜¾ç¤º
                    block.classList.add('hljs');
                });
            }, 0);
            
            updateStats();
            generateTOC();
            
            // ä¿å­˜å†å²è®°å½•ï¼ˆé˜²æŠ–å¤„ç†ï¼‰
            clearTimeout(updatePreview.timeout);
            updatePreview.timeout = setTimeout(() => {
                history.saveState(editor.value);
            }, 1000);
            
            // ä¸ºå¾…åŠåˆ—è¡¨æ·»åŠ äº¤äº’åŠŸèƒ½
            const todoItems = preview.querySelectorAll('.todo-list-item');
            todoItems.forEach((item, index) => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            item.classList.add('checked');
                        } else {
                            item.classList.remove('checked');
                        }
                        
                        // æ›´æ–°ç¼–è¾‘å™¨ä¸­çš„å†…å®¹
                        const lines = editor.value.split('\n');
                        let todoIndex = -1;
                        
                        // æ‰¾åˆ°å¯¹åº”çš„å¾…åŠäº‹é¡¹è¡Œ
                        for (let i = 0; i < lines.length; i++) {
                            if (lines[i].match(/^\[ \] .*/)) {
                                todoIndex++;
                                if (todoIndex === index) {
                                    lines[i] = lines[i].replace('[ ]', '[x]');
                                    break;
                                }
                            } else if (lines[i].match(/^\[x\] .*/)) {
                                todoIndex++;
                                if (todoIndex === index) {
                                    lines[i] = lines[i].replace('[x]', '[ ]');
                                    break;
                                }
                            }
                        }
                        
                        editor.value = lines.join('\n');
                        history.saveState(editor.value);
                    });
                }
            });
        }
        
        // æ·»åŠ é˜²æŠ–å®šæ—¶å™¨IDå±æ€§
        updatePreview.timeout = null;
        
        // åŒå‡»åŒæ­¥æ»šåŠ¨åŠŸèƒ½
        editor.addEventListener('dblclick', () => {
            const cursorPos = editor.selectionStart;
            const lines = editor.value.split('\n');
            const totalLines = lines.length;
            const textBeforeCursor = editor.value.substring(0, cursorPos);
            const lineNum = textBeforeCursor.split('\n').length;

            let lastHeading = null;
            for (let i = 0; i < lineNum; i++) {
                const m = lines[i].match(/^(#{1,6})\s+(.*)$/);
                if (m) lastHeading = m[2];
            }

            if (lastHeading) {
                const id = 'heading-' + lastHeading.replace(/\s+/g, '-');
                const esc = (s) => (window.CSS && CSS.escape) ? CSS.escape(s) : s;
                const el = preview.querySelector('#' + esc(id));
                if (el) {
                    el.classList.add('sync-highlight');
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => { el.classList.remove('sync-highlight'); }, 1000);
                    return;
                }
            }

            const ratio = Math.max(0, Math.min(1, (lineNum - 1) / Math.max(1, totalLines - 1)));
            const maxScroll = preview.scrollHeight - preview.clientHeight;
            preview.scrollTop = ratio * maxScroll;
        });

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const text = editor.value;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            const lines = text.split('\n').length;
            
            wordCount.textContent = `å­—æ•°: ${words}`;
            charCount.textContent = `å­—ç¬¦: ${chars}`;
            lineCount.textContent = `è¡Œæ•°: ${lines}`;
        }

        // æ’å…¥æ–‡æœ¬åˆ°å…‰æ ‡ä½ç½®
        function insertAtCursor(text) {
            const startPos = editor.selectionStart;
            const endPos = editor.selectionEnd;
            const before = editor.value.substring(0, startPos);
            const after = editor.value.substring(endPos);
            
            editor.value = before + text + after;
            editor.selectionStart = editor.selectionEnd = startPos + text.length;
            editor.focus();
            updatePreview();
        }

        // åœ¨å½“å‰è¡Œæ’å…¥æ–‡æœ¬
        function insertAtLineStart(text) {
            const cursorPos = editor.selectionStart;
            const textBefore = editor.value.substring(0, cursorPos);
            const lines = textBefore.split('\n');
            const currentLineIndex = lines.length - 1;
            
            // æ‰¾åˆ°å½“å‰è¡Œçš„å¼€å§‹ä½ç½®
            const lineStartPos = cursorPos - lines[currentLineIndex].length;
            
            const before = editor.value.substring(0, lineStartPos);
            const after = editor.value.substring(lineStartPos);
            
            editor.value = before + text + after;
            editor.selectionStart = editor.selectionEnd = cursorPos + text.length;
            editor.focus();
            updatePreview();
        }

        // åˆ›å»ºå¹¶ä¸‹è½½æ–‡ä»¶
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // è¯»å–æ–‡ä»¶å†…å®¹
        function readFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                editor.value = e.target.result;
                updatePreview();
            };
            reader.readAsText(file);
        }

        function getFiles() {
            try {
                const v = localStorage.getItem('typora-files');
                return v ? JSON.parse(v) : [];
            } catch (e) {
                return [];
            }
        }

        function setFiles(files) {
            localStorage.setItem('typora-files', JSON.stringify(files));
        }

        function setCurrentFileId(id) {
            currentFileId = id;
            localStorage.setItem('typora-current', id || '');
        }

        function renderFileList() {
            const files = getFiles();
            fileListEl.innerHTML = files.map(f => {
                const d = new Date(f.updatedAt);
                const t = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                const active = f.id === currentFileId ? ' style="background:#eef2f7"' : '';
                return `<div class="file-item" data-id="${f.id}"${active}><div><div class="file-name">${f.name}</div><div class="file-meta">${t}</div></div><div class="file-actions"><button class="file-action" data-action="delete" data-id="${f.id}">âœ•</button></div></div>`;
            }).join('');
        }

        function loadFileById(id) {
            const files = getFiles();
            const f = files.find(x => x.id === id);
            if (!f) return;
            editor.value = f.content || '';
            setCurrentFileId(id);
            updatePreview();
            renderFileList();
        }

        function newFileAction() {
            editor.value = '';
            setCurrentFileId(null);
            updatePreview();
        }

        function saveFileAction() {
            const files = getFiles();
            let f = files.find(x => x.id === currentFileId);
            const baseName = f ? f.name : 'æœªå‘½å';
            const name = prompt('æ–‡ä»¶å', baseName) || baseName;
            if (f) {
                f.name = name;
                f.content = editor.value;
                f.updatedAt = Date.now();
            } else {
                const id = Math.random().toString(36).slice(2);
                f = { id, name, content: editor.value, updatedAt: Date.now() };
                files.unshift(f);
                setCurrentFileId(id);
            }
            setFiles(files);
            renderFileList();
            alert('å·²ä¿å­˜');
        }

        // æœç´¢åŠŸèƒ½
        function searchInPreview(keyword) {
            if (!keyword) {
                // æ¸…é™¤é«˜äº®
                preview.innerHTML = preview.innerHTML.replace(/<mark>(.*?)<\/mark>/g, '$1');
                return;
            }
            
            // å…ˆæ¸…é™¤ä¹‹å‰çš„é«˜äº®
            preview.innerHTML = preview.innerHTML.replace(/<mark>(.*?)<\/mark>/g, '$1');
            
            // æ·»åŠ æ–°çš„é«˜äº®
            const regex = new RegExp(`(${keyword})`, 'gi');
            preview.innerHTML = preview.innerHTML.replace(regex, '<mark>$1</mark>');
        }

        // å·¥å…·æ æŒ‰é’®äº‹ä»¶
        document.getElementById('boldBtn').addEventListener('click', () => {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const before = editor.value.substring(0, start);
            const after = editor.value.substring(end);
            
            if (selectedText) {
                // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™åŒ…è£¹åŠ ç²—æ ‡è®°
                editor.value = before + '**' + selectedText + '**' + after;
                editor.selectionStart = start + 2;
                editor.selectionEnd = start + 2 + selectedText.length;
            } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™æ’å…¥åŠ ç²—æ ‡è®°
                insertAtCursor('****');
                editor.selectionStart = start + 2;
                editor.selectionEnd = start + 2;
            }
            editor.focus();
            updatePreview();
        });

        document.getElementById('italicBtn').addEventListener('click', () => {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const before = editor.value.substring(0, start);
            const after = editor.value.substring(end);
            
            if (selectedText) {
                // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™åŒ…è£¹æ–œä½“æ ‡è®°
                editor.value = before + '*' + selectedText + '*' + after;
                editor.selectionStart = start + 1;
                editor.selectionEnd = start + 1 + selectedText.length;
            } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™æ’å…¥æ–œä½“æ ‡è®°
                insertAtCursor('**');
                editor.selectionStart = start + 1;
                editor.selectionEnd = start + 1;
            }
            editor.focus();
            updatePreview();
        });

        document.getElementById('headingBtn').addEventListener('click', () => {
            insertAtLineStart('# ');
        });

        document.getElementById('linkBtn').addEventListener('click', () => {
            insertAtCursor('[é“¾æ¥æ–‡æœ¬](http://)');
        });

        document.getElementById('imageBtn').addEventListener('click', () => {
            insertAtCursor('![æ›¿ä»£æ–‡æœ¬](å›¾ç‰‡åœ°å€)');
        });

        document.getElementById('ulBtn').addEventListener('click', () => {
            insertAtLineStart('- ');
        });

        document.getElementById('olBtn').addEventListener('click', () => {
            insertAtLineStart('1. ');
        });

        document.getElementById('todoListBtn').addEventListener('click', () => {
            insertAtLineStart('[ ] ');
        });

        document.getElementById('quoteBtn').addEventListener('click', () => {
            insertAtLineStart('> ');
        });

        document.getElementById('codeBtn').addEventListener('click', () => {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const before = editor.value.substring(0, start);
            const after = editor.value.substring(end);
            
            if (selectedText) {
                // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™åŒ…è£¹ä»£ç å—æ ‡è®°ï¼ˆé»˜è®¤ä½¿ç”¨javascriptè¯­è¨€ï¼‰
                editor.value = before + '\n```javascript\n' + selectedText + '\n```\n' + after;
                editor.selectionStart = start + 16;
            } else {
                // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™æ’å…¥ä»£ç å—æ ‡è®°ï¼ˆé»˜è®¤ä½¿ç”¨javascriptè¯­è¨€ï¼‰
                insertAtCursor('\n```javascript\n\n```\n');
                editor.selectionStart = start + 16;
                editor.selectionEnd = start + 16;
            }
            editor.focus();
            updatePreview();
        });

        document.getElementById('hrBtn').addEventListener('click', () => {
            insertAtCursor('\n---\n');
        });

        document.getElementById('highlightBtn').addEventListener('click', () => {
            insertAtCursor('====');
        });

        document.getElementById('calloutInfoBtn').addEventListener('click', () => {
            insertAtCursor('\n!!!info\nä¿¡æ¯å†…å®¹\n!!!\n');
        });

        document.getElementById('calloutWarningBtn').addEventListener('click', () => {
            insertAtCursor('\n!!!warning\nè­¦å‘Šå†…å®¹\n!!!\n');
        });

        document.getElementById('calloutErrorBtn').addEventListener('click', () => {
            insertAtCursor('\n!!!error\né”™è¯¯å†…å®¹\n!!!\n');
        });

        document.getElementById('previewToggle').addEventListener('click', () => {
            preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
        });

        document.getElementById('fullscreenBtn').addEventListener('click', () => {
            document.body.classList.toggle('fullscreen');
        });

        document.getElementById('tocToggle').addEventListener('click', () => {
            toc.classList.toggle('show');
        });

        // æ–‡ä»¶æ“ä½œäº‹ä»¶
        document.getElementById('newFile').addEventListener('click', () => {
            newFileAction();
        });

        document.getElementById('openFile').addEventListener('click', () => {
            fileInput.click();
        });

        document.getElementById('saveFile').addEventListener('click', () => {
            saveFileAction();
        });

        document.getElementById('downloadMd').addEventListener('click', () => {
            downloadFile(editor.value, 'document.md', 'text/markdown');
        });

        document.getElementById('downloadHtml').addEventListener('click', () => {
            const htmlContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Markdown Document</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; }
        h1, h2, h3, h4, h5, h6 { margin-top: 24px; margin-bottom: 16px; font-weight: 600; }
        h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
        p { margin-top: 0; margin-bottom: 16px; }
        a { color: #0366d6; text-decoration: none; }
        a:hover { text-decoration: underline; }
        pre { padding: 16px; overflow: auto; font-size: 85%; line-height: 1.45; background-color: #f6f8fa; border-radius: 6px; }
        code { padding: 0.2em 0.4em; margin: 0; font-size: 85%; background-color: rgba(27,31,35,0.05); border-radius: 6px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, Courier, monospace; }
        pre code { padding: 0; margin: 0; font-size: 100%; background-color: transparent; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Monaco, Courier, monospace; }
        blockquote { padding: 0 1em; color: #6a737d; border-left: 0.25em solid #dfe2e5; margin: 0 0 16px; }
        ul, ol { padding-left: 2em; margin-bottom: 16px; }
        li { margin-bottom: 4px; }
        table { display: block; width: 100%; overflow: auto; border-collapse: collapse; margin-bottom: 16px; border-spacing: 0; border-collapse: collapse; }
        table th, table td { padding: 6px 13px; border: 1px solid #dfe2e5; }
        table tr:nth-child(2n) { background-color: #f6f8fa; }
        .todo-list-item { list-style: none; }
        .todo-list-item input[type="checkbox"] { margin-right: 8px; }
        .todo-list-item.checked { text-decoration: line-through; color: #6c757d; }
        .callout { padding: 16px; margin-bottom: 16px; border-radius: 6px; background-color: #f0f4f8; border-left: 4px solid #4285f4; }
        .callout.info { background-color: #e8f0fe; border-left-color: #4285f4; }
        .callout.warning { background-color: #fef7e0; border-left-color: #f9ab00; }
        .callout.error { background-color: #fce8e6; border-left-color: #ea4335; }
        .highlight { background-color: #ffeb3b; padding: 0 2px; }
    </style>
</head>
<body>
    ${parseMarkdown(editor.value)}
</body>
</html>`;
            downloadFile(htmlContent, 'document.html', 'text/html');
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                readFile(file);
            }
        });

        // æœç´¢åŠŸèƒ½
        searchInput.addEventListener('input', (e) => {
            searchInPreview(e.target.value);
        });

        // å¿«æ·é”®å¤„ç†
        document.addEventListener('keydown', (e) => {
            // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†Ctrlé”®
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'b':
                    case 'B':
                        e.preventDefault();
                        // åŠ ç²—åŠŸèƒ½ï¼šåŒ…è£¹é€‰ä¸­æ–‡æœ¬
                        const boldStart = editor.selectionStart;
                        const boldEnd = editor.selectionEnd;
                        const boldSelectedText = editor.value.substring(boldStart, boldEnd);
                        const boldBefore = editor.value.substring(0, boldStart);
                        const boldAfter = editor.value.substring(boldEnd);
                        
                        if (boldSelectedText) {
                            // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™åŒ…è£¹åŠ ç²—æ ‡è®°
                            editor.value = boldBefore + '**' + boldSelectedText + '**' + boldAfter;
                            editor.selectionStart = boldStart + 2;
                            editor.selectionEnd = boldStart + 2 + boldSelectedText.length;
                        } else {
                            // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™æ’å…¥åŠ ç²—æ ‡è®°
                            insertAtCursor('****');
                            editor.selectionStart = boldStart + 2;
                            editor.selectionEnd = boldStart + 2;
                        }
                        editor.focus();
                        updatePreview();
                        break;
                    case 'i':
                    case 'I':
                        e.preventDefault();
                        // æ–œä½“åŠŸèƒ½ï¼šåŒ…è£¹é€‰ä¸­æ–‡æœ¬
                        const italicStart = editor.selectionStart;
                        const italicEnd = editor.selectionEnd;
                        const italicSelectedText = editor.value.substring(italicStart, italicEnd);
                        const italicBefore = editor.value.substring(0, italicStart);
                        const italicAfter = editor.value.substring(italicEnd);
                        
                        if (italicSelectedText) {
                            // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™åŒ…è£¹æ–œä½“æ ‡è®°
                            editor.value = italicBefore + '*' + italicSelectedText + '*' + italicAfter;
                            editor.selectionStart = italicStart + 1;
                            editor.selectionEnd = italicStart + 1 + italicSelectedText.length;
                        } else {
                            // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™æ’å…¥æ–œä½“æ ‡è®°
                            insertAtCursor('**');
                            editor.selectionStart = italicStart + 1;
                            editor.selectionEnd = italicStart + 1;
                        }
                        editor.focus();
                        updatePreview();
                        break;
                    case 'h':
                    case 'H':
                        e.preventDefault();
                        insertAtLineStart('# ');
                        break;
                    case 'k':
                    case 'K':
                        e.preventDefault();
                        insertAtCursor('[é“¾æ¥æ–‡æœ¬](http://)');
                        break;
                    case 'u':
                    case 'U':
                        e.preventDefault();
                        insertAtLineStart('- ');
                        break;
                    case 'q':
                    case 'Q':
                        e.preventDefault();
                        insertAtLineStart('> ');
                        break;
                    case 'p':
                    case 'P':
                        e.preventDefault();
                        preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
                        break;
                    case 's':
                    case 'S':
                        e.preventDefault();
                        saveFileAction();
                        break;
                    case 'n':
                    case 'N':
                        e.preventDefault();
                        editor.value = '';
                        updatePreview();
                        break;
                    case 'o':
                    case 'O':
                        e.preventDefault();
                        if (e.shiftKey) {
                            insertAtLineStart('1. ');
                        } else {
                            fileInput.click();
                        }
                        break;
                    case 'j':
                    case 'J':
                        e.preventDefault();
                        toc.classList.toggle('show');
                        break;
                    case 'f':
                    case 'F':
                        e.preventDefault();
                        searchInput.focus();
                        break;
                    case 'z':
                    case 'Z':
                        // æ’¤é”€ (Ctrl+Z)
                        e.preventDefault();
                        const prevState = history.undo();
                        if (prevState !== null) {
                            editor.value = prevState;
                            updatePreview();
                        }
                        break;
                    case 'y':
                    case 'Y':
                        // é‡åš (Ctrl+Y)
                        e.preventDefault();
                        const nextState = history.redo();
                        if (nextState !== null) {
                            editor.value = nextState;
                            updatePreview();
                        }
                        break;
                }
                
                // æ£€æŸ¥æ˜¯å¦æŒ‰ä¸‹äº†Ctrl+Shifté”®
                if (e.shiftKey) {
                    switch (e.key) {
                        case 'i':
                        case 'I':
                            e.preventDefault();
                            insertAtCursor('![æ›¿ä»£æ–‡æœ¬](å›¾ç‰‡åœ°å€)');
                            break;
                        case 'c':
                        case 'C':
                            e.preventDefault();
                            // ä»£ç å—åŠŸèƒ½ï¼šåŒ…è£¹é€‰ä¸­æ–‡æœ¬
                            const codeStart = editor.selectionStart;
                            const codeEnd = editor.selectionEnd;
                            const codeSelectedText = editor.value.substring(codeStart, codeEnd);
                            const codeBefore = editor.value.substring(0, codeStart);
                            const codeAfter = editor.value.substring(codeEnd);
                            
                            if (codeSelectedText) {
                                editor.value = codeBefore + '\n```javascript\n' + codeSelectedText + '\n```\n' + codeAfter;
                                editor.selectionStart = codeStart + 16;
                            } else {
                                insertAtCursor('\n```javascript\n\n```\n');
                                editor.selectionStart = codeStart + 16;
                                editor.selectionEnd = codeStart + 16;
                            }
                            editor.focus();
                            updatePreview();
                            break;
                        case 'h':
                        case 'H':
                            e.preventDefault();
                            const startPos = editor.selectionStart;
                            const endPos = editor.selectionEnd;
                            if (startPos !== endPos) {
                                // å¦‚æœæœ‰é€‰ä¸­æ–‡æœ¬ï¼Œåˆ™æ·»åŠ é«˜äº®
                                const selectedText = editor.value.substring(startPos, endPos);
                                const before = editor.value.substring(0, startPos);
                                const after = editor.value.substring(endPos);
                                editor.value = before + '==' + selectedText + '==' + after;
                                editor.selectionStart = startPos + 2;
                                editor.selectionEnd = startPos + 2 + selectedText.length;
                            } else {
                                // å¦åˆ™æ’å…¥é«˜äº®æ ‡è®°
                                insertAtCursor('====');
                            }
                            editor.focus();
                            updatePreview();
                            break;
                        case 'o':
                        case 'O':
                            e.preventDefault();
                            insertAtLineStart('1. ');
                            break;
                        case 't':
                        case 'T':
                            e.preventDefault();
                            insertAtLineStart('[ ] ');
                            break;
                    }
                }
            }
            
            // F11å…¨å±
            if (e.key === 'F11') {
                e.preventDefault();
                document.body.classList.toggle('fullscreen');
            }
        });

        // åˆå§‹åŒ–
        editor.addEventListener('input', updatePreview);
        window.addEventListener('load', () => {
            const files = getFiles();
            const current = localStorage.getItem('typora-current');
            if (files.length === 0) {
                const legacy = localStorage.getItem('markdown-content');
                if (legacy) {
                    const id = Math.random().toString(36).slice(2);
                    const f = { id, name: 'æœªå‘½å', content: legacy, updatedAt: Date.now() };
                    setFiles([f]);
                    setCurrentFileId(id);
                    editor.value = legacy;
                }
            } else {
                if (current) {
                    setCurrentFileId(current);
                    const f = files.find(x => x.id === current);
                    if (f) editor.value = f.content || '';
                }
            }
            renderFileList();
            updatePreview();
        });

        newSidebarFileBtn.addEventListener('click', () => {
            newFileAction();
        });

        fileListEl.addEventListener('click', (e) => {
            const t = e.target;
            const action = t.getAttribute('data-action');
            if (action === 'delete') {
                const id = t.getAttribute('data-id');
                const files = getFiles().filter(x => x.id !== id);
                setFiles(files);
                if (currentFileId === id) setCurrentFileId(null);
                renderFileList();
                return;
            }
            const item = t.closest('.file-item');
            if (item && item.getAttribute('data-id')) {
                loadFileById(item.getAttribute('data-id'));
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–é¢„è§ˆ
        updatePreview();
    </script>
</body>
</html>
